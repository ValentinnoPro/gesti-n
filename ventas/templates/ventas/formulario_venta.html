{% extends "base.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 700px;">
    <h3 class="mb-3">Editar Venta</h3>

    <!-- Filtros de búsqueda -->
    <form method="get" class="mb-3">
        <div class="row g-2">
            <div class="col">
                <input type="text" name="buscar_cliente" class="form-control form-control-sm" placeholder="Buscar cliente..." value="{{ cliente_query }}">
            </div>
            <div class="col">
                <input type="text" name="buscar_producto" class="form-control form-control-sm" placeholder="Buscar producto..." value="{{ producto_query }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-outline-primary">Buscar</button>
                <a href="{% url 'editar_venta' venta.id %}" class="btn btn-sm btn-outline-secondary">Limpiar</a>
            </div>
        </div>
    </form>

    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-sm mt-2 text-center">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if not clientes.exists and not productos.exists %}
        <p class="text-muted">Usá los filtros para buscar clientes y productos.</p>
    {% endif %}

    <!-- Formulario de edición -->
    <form method="post" class="border rounded p-3 shadow-sm bg-light">
        {% csrf_token %}

        <!-- Selección cliente -->
        {% if clientes.exists %}
        <div class="mb-3">
            <label for="cliente" class="form-label small">Cliente:</label>
            <select name="cliente" id="cliente" class="form-select form-select-sm" required>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_seleccionado|stringformat:"s" %}selected{% endif %}>
                        {{ cliente.nombre }} {{ cliente.apellido }}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% else %}
            <p class="text-muted">No se encontraron clientes. Buscá para ver resultados.</p>
        {% endif %}

        <!-- Productos -->
        <h5 class="mt-3 mb-2">Productos:</h5>
        {% if productos.exists %}
            {% for producto in productos %}
                <div class="mb-3 border rounded p-2 bg-white">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="productos" id="producto_{{ producto.id }}" value="{{ producto.id }}"
                            {% if producto.id|stringformat:"s" in productos_seleccionados %}checked{% endif %}>
                        <label class="form-check-label small" for="producto_{{ producto.id }}">
                            {{ producto.nombre }} - ${{ producto.precio }} (Stock: {{ producto.stock }})
                        </label>
                    </div>

                    <input type="number" name="cantidad_{{ producto.id }}" id="cantidad_{{ producto.id }}"
                        class="form-control form-control-sm mt-1"
                        min="1" placeholder="Cantidad"
                        value="{% for id, cant in cantidades_anteriores_list %}{% if id == producto.id %}{{ cant }}{% endif %}{% endfor %}">
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No se encontraron productos. Buscá para ver resultados.</p>
        {% endif %}

        <!-- Botones -->
        <div class="d-flex justify-content-between mt-3">
            <a href="{% url 'lista_ventas' %}" class="btn btn-sm btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-sm btn-primary">Actualizar Venta</button>
        </div>
    </form>
</div>
{% endblock %}
